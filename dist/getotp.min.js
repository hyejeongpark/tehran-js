"use strict";(function(e){function t(){function t(e,t){var i=t[e];if("string"==typeof i&&(i=i.trim()),"ui_mode"===e){var n=["modal","sticky","embed"];if(!n.includes(i))return!1}return"dev_mode"!==e||"boolean"==typeof i}function i(e,t){c("onOtpBeforeLoad",{});var i=document.createElement("div");i.setAttribute("id",b.iframe_settings.iframe_container_id),i.setAttribute("class",b.iframe_settings.iframe_container_class);var n=document.createElement("iframe");n.setAttribute("id",b.iframe_settings.iframe_id),n.setAttribute("class",b.iframe_settings.iframe_class),i.appendChild(n),console.log("iframe.src",e),n.src=e,n.width="100%",n.style.border="none",t.appendChild(i);var o=b;n.addEventListener("load",function(){var e=document.getElementById(o.modal_spinner_id);e&&e.parentNode.removeChild(e)})}function n(e){var t=e+"px",i=document.getElementById("getotp_iframe");i.style.height=e+"px",console.log("update iframe height",t),b.embed_height=t,c("onOtpAfterLoad",{})}function o(e){var t=new tingle.modal({footer:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",onOpen:function(){c("onOpenModal",{})},onClose:function(){t.destroy(),c("onCloseModal",{})},beforeClose:function(){return!0}});b.active_modal=t;var n=b.embed_dom_id,o=b.modal_spinner_id,r='<svg width="38" height="38" viewBox="0 0 38 38" xmlns="http://www.w3.org/2000/svg" stroke="#000"> <g fill="none" fill-rule="evenodd"> <g transform="translate(1 1)" stroke-width="2"> <circle stroke-opacity=".5" cx="18" cy="18" r="18" /> <path d="M36 18c0-9.94-8.06-18-18-18"> <animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="1s" repeatCount="indefinite" /> </path> </g> </g> </svg>',a='<div id="'+o+'" style="display: flex; align-items: center; justify-content: center; height: 100%;">'+r+"</div>";t.setContent('<div id="'+n+'">'+a+"</div>");var d=document.getElementById(n);i(e,d),s(),t.open()}function r(){b.is_loading_script=!0,b.is_script_loaded=!1;var e=f("getotp_modal.min.js");u(e,function(){var e=f("getotp_modal.min.css");m(e,function(){b.is_loading_script=!1,b.is_script_loaded=!0,c("modalScriptLoaded",{})})})}function s(){var e=document.createElement("style"),t=a();t&&(e.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(e))}function a(){return"sticky"===b.settings.ui_mode?"div#"+b.iframe_settings.iframe_container_id+" { position: fixed; bottom: 0; width: 100%; background-color: white; }":null}function d(e){return e+"pin/"}function c(t,i){var n=new CustomEvent(t,{detail:i});e.dispatchEvent(n)}function l(e){27==e&&"modal"==b.settings.ui_mode&&b.closeModal(),c("onOtpKeypress",{keycode:e})}function u(e,t){var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src=e;var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(i,n),i.addEventListener?i.addEventListener("load",t,!1):i.attachEvent("onreadystatechange",function(){/complete|loaded/.test(i.readyState)&&t()})}function m(e,t){var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=e;var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(i,n),t()}function _(){var e=new URL(b.script_origin),t=e.origin;return t}function g(e){var t=e.split(".").pop(),i="/static/js/";return"css"===t&&(i="/static/css/"),b.settings.dev_mode&&(i="/dist/"),i}function f(e){var t=_(),i=g(e),n=t+i+e;return n}function p(e,t){b.settings.ui_mode="embed",i(e,t),s()}function v(t){b.is_script_loaded?o(t):(b.is_loading_script||r(),e.addEventListener("modalScriptLoaded",function(e){o(t)}))}function h(e){b.settings.ui_mode="sticky";var t=document.body;i(e,t),s()}var y={ui_mode:"modal",url_storage_key:"getotp_form_url",dev_mode:!1},b={settings:y,iframe_settings:{iframe_container_id:"getotp_iframe_parent",iframe_container_class:"",iframe_id:"getotp_iframe",iframe_class:""},trusted_origins:["https://otp.dev"],is_loading_script:!1,is_script_loaded:!1,active_modal:null,embed_height:null,embed_dom_id:"getotp_modal_embed_body",modal_spinner_id:"getotp_modal_spinner",script_origin:document.currentScript&&document.currentScript.src,init:function(e){for(var i in e)this.settings.hasOwnProperty(i)&&t(i,e)&&(this.settings[i]=e[i]);"modal"===this.settings.ui_mode&&(this.is_loading_script||this.is_script_loaded||r())},getotpServerMessage:function(t){var i=e.location.origin;if(t.origin==i||b.trusted_origins.includes(t.origin)){var n=t.data;"function"==typeof b[n.func]&&b[n.func].call(null,n.message)}else console.error("Server callback failed because event origin "+t.origin+" is not define inside trusted_origins")},iframeHeightCallback:function(e){var t=e.embed_height;n(t)},keyPressCallback:function(e){var t=e.keycode;l(t)},otpClientCallback:function(e){var t=e.otp_id,i=e.status,n=e.redirect_url,o={otp_id:t,status:i,redirect_url:n};"success"===i?c("onOtpSucces",o):"fail"===i&&c("onOtpFailed",o)},showEmbed:function(e,t){var i=d(e);return sessionStorage.setItem(this.settings.url_storage_key,i),p(i,t),!0},reloadEmbed:function(e){var t=sessionStorage.getItem(this.settings.url_storage_key);t?p(t,e):console.error("No previous otp form url define in session storage with key "+this.settings.url_storage_key)},showModal:function(e){var t=d(e);sessionStorage.setItem(this.settings.url_storage_key,t),v(t)},closeModal:function(e){this.active_modal&&this.active_modal.close()},reloadModal:function(){var e=sessionStorage.getItem(this.settings.url_storage_key);if(e)return v(e),!0;console.error("No previous otp form url define in session storage with key "+this.settings.url_storage_key)},showSticky:function(e){var t=d(e);return sessionStorage.setItem(this.settings.url_storage_key,t),h(t),!0},reloadSticky:function(){var e=sessionStorage.getItem(this.settings.url_storage_key);if(e)return h(e),!0;console.error("No previous otp form url define in session storage with key "+this.settings.url_storage_key)},connect:function(e,t){var i=e.success_redirect_url,n=e.fail_redirect_url,o=e.user_email,r=t.api_url,s=t.api_key,a=t.api_token,d={callback_url:i,success_redirect_url:i,fail_redirect_url:n,channel:"email",email:o,embed:"compact"};r+="api/verify/";var c=btoa(s+":"+a),l={method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Basic "+c},body:JSON.stringify(d)},u=fetch(r,l).then(function(e){return e.json()});return u},getEmbedHeight:function(){return this.embed_height},onOpenModal:function(t){e.addEventListener("onOpenModal",function(e){var i=e.detail;t(i)})},onCloseModal:function(t){e.addEventListener("onCloseModal",function(e){var i=e.detail;t(i)})},onSuccess:function(t){e.addEventListener("onOtpSucces",function(e){var i=e.detail;t(i)})},onFailed:function(t){e.addEventListener("onOtpFailed",function(e){var i=e.detail;t(i)})},addOrigin:function(e){return e=e.replace(/\/$/,""),this.trusted_origins.push(e),this.trusted_origins},clearSession:function(){sessionStorage.removeItem(this.settings.url_storage_key)}};return b}void 0===e.getotp&&(e.getotp=t()),e.addEventListener?e.addEventListener("message",e.getotp.getotpServerMessage,!1):e.attachEvent&&e.attachEvent("onmessage",e.getotp.getotpServerMessage,!1)})(window);